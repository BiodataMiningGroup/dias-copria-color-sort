angular.module("dias.transects").controller("SortByColorController",["$scope","ColorSortSequence","$interval","msg","TRANSECT_ID","sort",function(e,o,r,t,n,c){"use strict";var s="color-",i="color-colors",a="color-sequence-",u=5e3,l=!1;e.hasCache(i)||(l=!0,e.setCache(i,o.query({transect_id:n},function(){l=!1})));var f=e.getCache(i),g=!1,C=function(){e.setLoading(!1)},h=function(c){var s,i=a+c,l=function(o){o.length>0&&(r.cancel(s),g=!1,e.setCache(i,o),f.push(c),t.success("The new color is now available for sorting."))},C=function(e){r.cancel(s),g=!1,404===e.status?t.danger("The COPRIA pipeline for computing a new color sort sequence failed."):t.responseError(e)},h=function(){o.get({transect_id:n,color:c},l,C)};s=r(h,u)};e["new"]={color:"#000000"},e.toggle=function(r){var c=s+r;if(!e.active(c)){var i=a+r;e.hasCache(i)||(e.setLoading(!0),e.setCache(i,o.get({transect_id:n,color:r},C,t.responseError))),e.getCache(i).$promise.then(function(o){e.activateSorter(c,o)})}},e.active=function(e){if(e)return c.isSorterActive(s+e);for(var o=f.length-1;o>=0;o--)if(c.isSorterActive(s+f[o]))return!0;return!1},e.hasColors=function(){return f.length>0},e.getColors=function(){return f},e.isFetchingColors=function(){return l},e.isComputingNewColor=function(){return g},e.canRequestNewColor=function(){return!e.isFetchingColors()&&!e.isComputingNewColor()},e.requestNewColor=function(){if(e.canRequestNewColor()){var r=e["new"].color.substring(1),c=function(){g=!0,h(r)},s=function(e){405===e.status?t.warning("This color is already available (or still computing)."):t.responseError(e)};o.request({transect_id:n},{color:r},c,s)}}}]),angular.module("dias.transects").factory("ColorSortSequence",["$resource","URL",function(e,o){"use strict";return e(o+"/api/v1/transects/:transect_id/color-sort-sequence/:color",{},{get:{method:"GET",isArray:!0},request:{method:"POST"}})}]);